#!/bin/bash

version=0.20.9
trustgraph=/usr/local/trustgraph

exec >/tmp/output 2>&1
export DEBIAN_FRONTEND=noninteractive

apt update
apt upgrade

apt install -y python3 python3-pip unzip python3-venv
pip install -y --break-system-packages awscli

apt install -y podman-docker podman-compose

apt install -y wget

# Turn off docker warning
touch /etc/containers/nodocker

# install docker-compose.yaml
# grafana
# prometheus

mkdir -p ${trustgraph}
mkdir ${trustgraph}/deploy
mkdir ${trustgraph}/deploy/prometheus
mkdir ${trustgraph}/deploy/grafana
mkdir ${trustgraph}/deploy/grafana/dashboards
mkdir ${trustgraph}/deploy/grafana/provisioning

python3 -m venv ${trustgraph}/env
. ${trustgraph}/env/bin/activate

pip install trustgraph-cli==${version}

repo=https://raw.githubusercontent.com/trustgraph-ai/trustgraph/
repo_raw=${repo}/refs/tags/v${version}

wget -q -O- ${repo_raw}/prometheus/prometheus.yml \
     > ${trustgraph}/deploy/prometheus/prometheus.yml

wget -q -O- ${repo_raw}/grafana/dashboards/dashboard.json \
     > ${trustgraph}/deploy/grafana/dashboards/dashboard.json

wget -q -O- ${repo_raw}/grafana/provisioning/datasource.yml \
     > ${trustgraph}/deploy/grafana/provisioning/datasource.yml

wget -q -O- ${repo_raw}/grafana/provisioning/dashboard.yml \
     > ${trustgraph}/deploy/grafana/provisioning/dashboard.yml

chcon -Rt svirt_sandbox_file_t ${trustgraph}/deploy

base64 -d <<EOF | gzip -d > ${trustgraph}/deploy/docker-compose.yaml
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
EOF

cd /usr/local/trustgraph/deploy

podman-compose -f docker-compose.yaml pull

podman-compose -f docker-compose.yaml up -d


